<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Ad Earning Platform</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script src='//libtl.com/sdk.js' data-zone='10117888' data-sdk='show_10117888'></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script> 

    <style>
        /* Shared Styles */
        body { background-color: #f8f9fa; }
        .sidebar { background-color: #343a40; }
        .card-balance { border-left: 5px solid #28a745; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        .earning-value { font-size: 2.5rem; font-weight: 700; }
        .ad-box { background-color: #ecf0f1; border: 2px dashed #95a5a6; min-height: 250px; display: flex; align-items: center; justify-content: center; text-align: center; flex-direction: column; border-radius: 10px; padding: 20px; }
        
        /* Login Specific Styles */
        .login-page { background-color: #34495e; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-box { background-color: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        
        /* Hide sections initially */
        #main_dashboard, #loading_screen { display: none; }
    </style>
</head>
<body>

<div id="loading_screen" class="login-page">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <h4 class="ml-3 text-white">Checking login status...</h4>
</div>

<div id="login_page" class="login-page">
    <div class="login-box">
        <h3>Sign in to Earn Ads</h3>
        <p class="text-muted">Use your Telegram account to login instantly.</p>
        
        <script async src="https://telegram.org/js/telegram-widget.js?22" 
                data-telegram-login="YOUR_BOT_USERNAME" 
                data-size="large" 
                data-auth-url="https://yourdomain.com/login_handler.php" 
                data-request-access="write"></script>
                
        <p class="mt-3 small text-danger font-weight-bold">
            **‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£:** ‡¶è‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá **login_handler.php** ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
        </p>
    </div>
</div>

<div id="main_dashboard" class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar py-3">
            <div class="sidebar-sticky">
                <h5 class="text-white mb-4"><i class="fas fa-dollar-sign"></i> PANEL</h5>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link text-white active" href="#"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link text-danger mt-3" href="#" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
        </nav>

        <main role="main" class="col-md-10 ml-sm-auto px-4">
            <h1 class="h3 pt-3 pb-2 mb-4 border-bottom">Welcome, <span id="user_display_name">Loading...</span>!</h1>

            <div class="row mb-5">
                <div class="col-md-5 mb-3">
                    <div class="card card-balance p-3 bg-white">
                        <div class="row no-gutters align-items-center">
                            <div class="col-auto mr-3">
                                <i class="fas fa-piggy-bank fa-3x text-success"></i>
                            </div>
                            <div class="col">
                                <div class="text-success font-weight-bold text-uppercase mb-1">Current Balance</div>
                                <div class="earning-value text-dark" id="current_balance_value">$ 0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card card-earning p-3 bg-light">
                        <i class="fas fa-eye text-primary mb-1"></i>
                        <div class="text-muted small">Today's Ad Views</div>
                        <h2 class="text-primary" id="ads_viewed_today_value">0 Ads</h2>
                    </div>
                </div>
            </div>

            <hr>

            <h3 class="mb-3">üì∫ <i class="fas fa-bullhorn"></i> View Today's Ad</h3>
            <div class="ad-box mb-5">
                <p class="lead text-dark">Click the button below to view the Rewarded Ad.</p>
                
                <div class="bg-white border rounded p-4 mb-3 w-75" style="min-height: 150px;">
                    </div>
                
                <button id="view_ad_btn" class="btn btn-success btn-lg" onclick="showRewardedAd()">
                    <i class="fas fa-play-circle"></i> View Rewarded Ad (Earn $0.01)
                </button>
                <div id="ad_message" class="mt-3 text-success font-weight-bold" style="display:none;"></div>
            </div>

            <hr>

            <h3 class="mt-5 mb-3 border-bottom pb-2"><i class="fas fa-money-check-alt"></i> Payout</h3>
            <div class="card p-4 mb-5">
                 <p class="text-danger font-weight-bold">Minimum Withdrawal Limit: $ <span id="min_withdraw_limit">50.00</span></p>
                <button class="btn btn-lg btn-danger disabled" id="withdraw_button" disabled onclick="requestWithdrawal()">Request Withdrawal</button>
            </div>
        </main>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    // ====================================================================
    // üîî Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ)
    // ====================================================================

    const firebaseConfig = {
      apiKey: "AIzaSyBTbvsww7lrnRPB3hzWD1foDQ6jUPhgfAE",
      authDomain: "easyearningsads.firebaseapp.com",
      databaseURL: "https://easyearningsads-default-rtdb.firebaseio.com",
      projectId: "easyearningsads",
      storageBucket: "easyearningsads.firebasestorage.app",
      messagingSenderId: "106083149623",
      appId: "1:106083149623:web:4d058e482126264d0b1cb2",
      measurementId: "G-YEHPMTSG02"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const database = firebase.database();
    const functions = firebase.functions();
    
    let currentUserID = null;
    const MONETAG_SDK_FUNC = window['show_10117888']; 

    // ====================================================================
    // üîî ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶´‡ßç‡¶≤‡ßã ‡¶è‡¶¨‡¶Ç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
    // ====================================================================

    function showScreen(screenId) {
        document.getElementById('loading_screen').style.display = 'none';
        document.getElementById('login_page').style.display = 'none';
        document.getElementById('main_dashboard').style.display = 'none';
        document.getElementById(screenId).style.display = 'flex'; // Use flex for centering login/loading
        if (screenId === 'main_dashboard') {
            document.getElementById(screenId).style.display = 'block'; // Use block for main content layout
        }
    }

    // A) ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶ö‡ßá‡¶ï (URL ‡¶è ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ)
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
        // A.1) ‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶•‡¶æ‡¶ï‡ßá (login_handler.php ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá)
        showScreen('loading_screen');
        auth.signInWithCustomToken(token)
            .then(() => {
                // ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá URL ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡¶ø‡¶®
                window.history.replaceState(null, null, window.location.pathname);
            })
            .catch((error) => {
                console.error("Custom Token Login Failed:", error);
                alert("Login failed! Invalid token or server error.");
                showScreen('login_page');
            });
    } else {
        // A.2) ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá Firebase ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        showScreen('loading_screen');
    }

    // B) Firebase Auth ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶ö‡ßá‡¶ï‡¶æ‡¶∞
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserID = user.uid;
            loadUserData(currentUserID);
            showScreen('main_dashboard');
        } else if (!token) {
            // ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶®‡ßá‡¶á ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ó‡¶á‡¶®‡¶ì ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á
            showScreen('login_page');
        }
    });

    function loadUserData(userId) {
        const userRef = database.ref('users/' + userId);

        userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            
            if (userData) {
                document.getElementById('user_display_name').textContent = userData.username || 'User';
                document.getElementById('current_balance_value').textContent = `$ ${userData.current_balance ? userData.current_balance.toFixed(2) : '0.00'}`;
                document.getElementById('ads_viewed_today_value').textContent = `${userData.ads_viewed_today || 0} Ads`;
                
                const minWithdraw = 50.00;
                const withdrawButton = document.getElementById('withdraw_button');
                if (userData.current_balance >= minWithdraw) {
                    withdrawButton.textContent = "Request Withdrawal";
                    withdrawButton.disabled = false;
                    withdrawButton.classList.remove('btn-danger', 'disabled');
                    withdrawButton.classList.add('btn-success');
                } else {
                    withdrawButton.textContent = `Request Withdrawal (Insufficient Balance - Need $${minWithdraw.toFixed(2)})`;
                    withdrawButton.disabled = true;
                    withdrawButton.classList.remove('btn-success');
                    withdrawButton.classList.add('btn-danger', 'disabled');
                }
            }
        });
    }

    function logoutUser() {
        auth.signOut().then(() => {
            window.location.reload(); // ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
        }).catch((error) => {
            console.error("Logout Failed:", error);
            alert("Logout failed.");
        });
    }

    // ====================================================================
    // üí∞ Monetag ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
    // ====================================================================
    
    function showRewardedAd() {
        if (!currentUserID || !MONETAG_SDK_FUNC) {
            alert("Error: System not ready or user not logged in.");
            return;
        }

        const adMessage = document.getElementById('ad_message');
        const adButton = document.getElementById('view_ad_btn');
        
        adMessage.style.display = 'none';
        adButton.disabled = true;
        adButton.textContent = "Ad is loading...";

        MONETAG_SDK_FUNC({
            type: 'end',
            ymid: currentUserID, 
            requestVar: 'ad_view_earn_button' 
        })
        .then((result) => {
            if (result.reward_event_type === 'valued' || result.reward_event_type === 'viewed') {
                // *** ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ (Cloud Function) ***
                callAddEarningFunction(0.01, 'ad_view_reward');

                adMessage.textContent = `Success! Rewarded Ad viewed. Balance update pending.`;
                adMessage.classList.remove('text-danger');
                adMessage.classList.add('text-success');
            } else {
                adMessage.textContent = "Ad closed or failed. No reward granted.";
                adMessage.classList.remove('text-success');
                adMessage.classList.add('text-danger');
            }
            adMessage.style.display = 'block';
            adButton.textContent = "View Next Ad";
            adButton.disabled = false;
        })
        .catch((error) => {
            console.error("Monetag Ad Error:", error);
            adMessage.textContent = "Error: Ad failed to load. Try again later.";
            adMessage.classList.remove('text-success');
            adMessage.classList.add('text-danger');
            adMessage.style.display = 'block';
            adButton.textContent = "Try Viewing Ad Again";
            adButton.disabled = false;
        });
    }
    
    function callAddEarningFunction(amount, source) {
        const addEarning = functions.httpsCallable('addEarning'); 

        addEarning({ amount: amount, source: source })
            .then((result) => {
                console.log("Earning Function Result:", result.data);
                if (!result.data.success) {
                    // ‡¶Ø‡¶¶‡¶ø Cloud Function ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã error ‡¶Ü‡¶∏‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶∏‡ßÄ‡¶Æ‡¶æ)
                    alert(result.data.message || "An unknown error occurred on the server."); 
                }
            })
            .catch((error) => {
                console.error("Error calling Cloud Function:", error);
                alert("Security Error: Check Cloud Functions deployment.");
            });
    }

    function requestWithdrawal() {
        const confirmRequest = confirm("Confirm withdrawal request? Your balance will be reviewed by admin.");
        
        if (confirmRequest) {
            // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá Cloud Function ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶¨‡¶∏‡¶¨‡ßá
            alert("Withdrawal request sent! Admin will review.");
        }
    }
</script>

</body>
</html>
