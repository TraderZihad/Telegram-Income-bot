<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Ads - Telegram Mini App (Final Version)</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script src='//libtl.com/sdk.js' data-zone='10117888' data-sdk='show_10117888'></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script> 

    <style>
        /* Telegram Theme Variables */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #2481cc);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f4);
        }
        body { 
            background-color: var(--tg-bg);
            color: var(--tg-text);
            padding-bottom: 50px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .container { max-width: 600px; }
        .card { background-color: var(--tg-secondary-bg); border: none; }
        .card-balance { border-left: 5px solid var(--tg-link); box-shadow: 0 4px 6px rgba(0,0,0,.05); }
        .earning-value { font-size: 2.5rem; font-weight: 700; color: var(--tg-text); }
        .ad-box { background-color: var(--tg-bg); border: 2px dashed var(--tg-link); min-height: 250px; border-radius: 10px; padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-success { background-color: var(--tg-button); border-color: var(--tg-button); }
        .btn-success:hover { background-color: #1e7e34; border-color: #1c7430; }
        .text-danger { color: #dc3545 !important; }
    </style>
</head>
<body>

<main role="main" class="container py-3">
    <h1 class="h4 pt-3 pb-2 mb-4 border-bottom" style="color: var(--tg-text);">
        <i class="fas fa-wallet" style="color: var(--tg-link);"></i> Welcome, <span id="user_display_name">...</span>!
    </h1>

    <div class="row mb-5">
        <div class="col-12 mb-3">
            <div class="card card-balance p-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-piggy-bank fa-3x mr-3" style="color: var(--tg-link);"></i>
                    <div>
                        <div class="font-weight-bold text-uppercase mb-1" style="color: var(--tg-link); font-size: 0.8rem;">Current Balance (USD)</div>
                        <div class="earning-value" id="current_balance_value">$ 0.00</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 pr-1">
            <div class="card p-3 text-center">
                <i class="fas fa-chart-line mb-1" style="color: var(--tg-link);"></i>
                <div class="small" style="color: var(--tg-text);">Total Earnings</div>
                <h5 style="color: var(--tg-text);" id="total_earnings_value">$ 0.00</h5>
            </div>
        </div>
        <div class="col-6 pl-1">
            <div class="card p-3 text-center">
                <i class="fas fa-eye mb-1" style="color: var(--tg-link);"></i>
                <div class="small" style="color: var(--tg-text);">Today's Ad Views</div>
                <h5 style="color: var(--tg-text);" id="ads_viewed_today_value">0 Ads</h5>
            </div>
        </div>
    </div>

    <hr style="background-color: var(--tg-link);">

    <h4 class="mb-3" style="color: var(--tg-text);">📺 View Rewarded Ad</h4>
    <div class="ad-box mb-5">
        <p class="lead" style="color: var(--tg-text); font-size: 1rem;">Click the button below to view the Rewarded Ad.</p>
        
        <button id="view_ad_btn" class="btn btn-success btn-lg" onclick="showRewardedAd()">
            <i class="fas fa-play-circle"></i> View Rewarded Ad (Earn $0.01)
        </button>
        <div id="ad_message" class="mt-3 font-weight-bold" style="display:none; color: var(--tg-link);"></div>
    </div>

    <hr style="background-color: var(--tg-link);">

    <h4 class="mt-5 mb-3 border-bottom pb-2" style="color: var(--tg-text);">💸 Payout</h4>
    <div class="card p-4 mb-5">
         <p class="font-weight-bold" style="color: #dc3545;">Minimum Withdrawal Limit: $ <span id="min_withdraw_limit">50.00</span></p>
        <button class="btn btn-lg btn-danger disabled" id="withdraw_button" disabled onclick="requestWithdrawal()">Request Withdrawal</button>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    // ====================================================================
    // 🛑 টেলিগ্রাম ইনিশিয়ালাইজেশন এবং ইউজার ডেটা সংগ্রহ 
    // ====================================================================
    
    const WebApp = window.Telegram.WebApp;
    WebApp.ready();
    WebApp.expand(); 
    
    const initData = WebApp.initDataUnsafe;
    let currentUserID = null;
    let userTelegramData = {};
    
    if (initData && initData.user) {
        // টেলিগ্রাম ID (Firebase-এ UID হিসেবে ব্যবহার হবে)
        currentUserID = initData.user.id.toString(); 
        userTelegramData = initData.user;
    } else {
        // যদি Telegram ইউজার ডেটা না পাওয়া যায়
        WebApp.showAlert('Error: Cannot verify Telegram user. Please start the app via the bot.');
    }

    // ====================================================================
    // 🔔 Firebase কনফিগারেশন এবং ইনিশিয়ালাইজেশন 
    // ====================================================================

    const firebaseConfig = {
      apiKey: "AIzaSyBTbvsww7lrnRPB3hzWD1foDQ6jUPhgfAE",
      authDomain: "easyearningsads.firebaseapp.com",
      databaseURL: "https://easyearningsads-default-rtdb.firebaseio.com",
      projectId: "easyearningsads",
      storageBucket: "easyearningsads.firebasestorage.app",
      messagingSenderId: "106083149623",
      appId: "1:106083149623:web:4d058e482126264d0b1cb2",
      measurementId: "G-YEHPMTSG02"
    };

    firebase.initializeApp(firebaseConfig);

    const database = firebase.database();
    const functions = firebase.functions();
    const MONETAG_SDK_FUNC = window['show_10117888']; 

    // ====================================================================
    // 🔑 ইউজার ডেটা লোড লজিক
    // ====================================================================
    
    if (currentUserID) {
        // স্ক্রিন লোড হলে ডেটা লোড শুরু
        loadUserData(currentUserID);
        
        // ইউজার নেম ডিসপ্লে
        const userDisplayName = userTelegramData.first_name || 'User';
        document.getElementById('user_display_name').textContent = userDisplayName;
    }

    function loadUserData(userId) {
        const userRef = database.ref('users/' + userId);
        
        // 1. যদি ইউজার Firebase-এ না থাকে, তবে প্রাথমিক ডেটা তৈরি করুন (সিকিউরিটি লজিক Cloud Function এ থাকা ভালো)
        userRef.once('value', (snapshot) => {
            if (!snapshot.exists()) {
                console.log("Creating initial user data for Telegram ID:", userId);
                userRef.set({
                    username: userTelegramData.username || userTelegramData.first_name || 'TG User',
                    current_balance: 0.00,
                    total_earnings: 0.00,
                    ads_viewed_today: 0,
                    telegram_id: userId,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    console.log("Initial data created successfully.");
                }).catch(err => {
                    console.error("Error creating initial data:", err);
                    WebApp.showAlert("Failed to initialize user data. Please try again.");
                });
            }
        });


        // 2. রিয়েল-টাইম ডেটা আপডেট লিসেনার
        userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            
            if (userData) {
                document.getElementById('total_earnings_value').textContent = `$ ${userData.total_earnings ? userData.total_earnings.toFixed(2) : '0.00'}`;
                document.getElementById('current_balance_value').textContent = `$ ${userData.current_balance ? userData.current_balance.toFixed(2) : '0.00'}`;
                document.getElementById('ads_viewed_today_value').textContent = `${userData.ads_viewed_today || 0} Ads`;
                
                const minWithdraw = 50.00;
                const withdrawButton = document.getElementById('withdraw_button');
                
                if (userData.current_balance >= minWithdraw) {
                    withdrawButton.textContent = "Request Withdrawal";
                    withdrawButton.disabled = false;
                    withdrawButton.classList.remove('btn-danger', 'disabled');
                    withdrawButton.classList.add('btn-success');
                } else {
                    withdrawButton.textContent = `Request Withdrawal (Need $${minWithdraw.toFixed(2)})`;
                    withdrawButton.disabled = true;
                    withdrawButton.classList.remove('btn-success');
                    withdrawButton.classList.add('btn-danger', 'disabled');
                }
            }
        });
    }
    
    // ====================================================================
    // 💰 Monetag অ্যাড এবং আর্নিং লজিক (Cloud Function Call)
    // ====================================================================
    
    function showRewardedAd() {
        if (!currentUserID || !MONETAG_SDK_FUNC) {
            WebApp.showAlert("Error: System not ready. Please restart the app via the bot.");
            return;
        }

        const adMessage = document.getElementById('ad_message');
        const adButton = document.getElementById('view_ad_btn');
        
        adMessage.style.display = 'none';
        adButton.disabled = true;
        adButton.textContent = "Ad is loading...";

        MONETAG_SDK_FUNC({
            type: 'end',
            ymid: currentUserID, // Telegram ID Monetag-এ পাঠানো
            requestVar: 'ad_view_earn_button' 
        })
        .then((result) => {
            if (result.reward_event_type === 'valued' || result.reward_event_type === 'viewed') {
                // *** সার্ভারে টাকা যোগ করার ফাংশন কল - এটাই নিরাপত্তা দেয় ***
                callAddEarningFunction(0.01, 'ad_view_reward');

                adMessage.textContent = `Success! Rewarded Ad viewed. Balance update pending.`;
                adMessage.classList.remove('text-danger');
                adMessage.classList.add('text-success');
            } else {
                adMessage.textContent = "Ad closed or failed. No reward granted.";
                adMessage.classList.remove('text-success');
                adMessage.classList.add('text-danger');
            }
            adMessage.style.display = 'block';
            adButton.textContent = "View Next Ad";
            adButton.disabled = false;
        })
        .catch((error) => {
            console.error("Monetag Ad Error:", error);
            WebApp.showAlert("Error: Ad failed to load. Try again later.");
            adButton.textContent = "Try Viewing Ad Again";
            adButton.disabled = false;
        });
    }
    
    function callAddEarningFunction(amount, source) {
        // Firebase Cloud Function 'addEarning' কল
        const addEarning = functions.httpsCallable('addEarning'); 

        addEarning({ amount: amount, source: source, telegramId: currentUserID })
            .then((result) => {
                console.log("Earning Function Result:", result.data);
                if (!result.data.success) {
                    WebApp.showAlert(result.data.message || "An unknown server error occurred."); 
                }
            })
            .catch((error) => {
                console.error("Error calling Cloud Function:", error);
                WebApp.showAlert("Security Error: Could not connect to the earning server.");
            });
    }

    function requestWithdrawal() {
        WebApp.showConfirm('Confirm withdrawal request? Your balance will be reviewed by admin.', (isConfirmed) => {
            if (isConfirmed) {
                // এখানে Cloud Function কল করে উত্তোলনের অনুরোধ পাঠানোর লজিক বসবে
                WebApp.showAlert("Withdrawal request sent! Admin will review.");
            }
        });
    }
</script>

</body>
</html>
